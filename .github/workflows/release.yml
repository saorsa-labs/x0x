name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Reuse build matrix from build.yml
  build-release:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 GNU
          - platform: linux-x64-gnu
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false

          # Linux x86_64 musl
          - platform: linux-x64-musl
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            cross: true

          # Linux ARM64
          - platform: linux-arm64-gnu
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true

          # macOS x86_64
          - platform: macos-x64
            os: macos-13
            target: x86_64-apple-darwin
            cross: false

          # macOS ARM64
          - platform: macos-arm64
            os: macos-14
            target: aarch64-apple-darwin
            cross: false

          # Windows x86_64
          - platform: windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false

          # WASM
          - platform: wasm32-wasi
            os: ubuntu-latest
            target: wasm32-wasip1-threads
            cross: false

    steps:
      - uses: actions/checkout@v4

      - name: Checkout ant-quic
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/ant-quic
          path: ../ant-quic

      - name: Checkout saorsa-gossip
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/saorsa-gossip
          path: ../saorsa-gossip

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-target-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --locked

      - name: Build (native)
        if: ${{ !matrix.cross }}
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: x0x-${{ matrix.platform }}
          path: |
            target/${{ matrix.target }}/release/x0x*
            !target/${{ matrix.target }}/release/x0x.d
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: artifacts/**/*
          generate_release_notes: true

  publish-crates:
    name: Publish to crates.io
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout ant-quic
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/ant-quic
          path: ../ant-quic

      - name: Checkout saorsa-gossip
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/saorsa-gossip
          path: ../saorsa-gossip

      - uses: dtolnay/rust-toolchain@stable
      - name: Publish crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Publish in dependency order with delays
          cargo publish -p x0x-types || echo "x0x-types already published"
          sleep 30
          cargo publish -p x0x || echo "x0x already published"
          sleep 30
          cargo publish -p x0x-nodejs || echo "x0x-nodejs already published"
          sleep 30
          cargo publish -p x0x-python || echo "x0x-python already published"

  publish-npm:
    name: Publish to npm
    needs: publish-crates
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Checkout ant-quic
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/ant-quic
          path: ../ant-quic

      - name: Checkout saorsa-gossip
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/saorsa-gossip
          path: ../saorsa-gossip

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd bindings/nodejs
          npm publish --provenance --access public

  publish-pypi:
    name: Publish to PyPI
    needs: publish-crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout ant-quic
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/ant-quic
          path: ../ant-quic

      - name: Checkout saorsa-gossip
        uses: actions/checkout@v4
        with:
          repository: saorsa-labs/saorsa-gossip
          path: ../saorsa-gossip

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install maturin
        run: pip install maturin
      - name: Build and publish
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          cd bindings/python
          maturin publish

  create-github-release:
    name: Create GitHub Release
    needs: [publish-npm, publish-pypi]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.SAORSA_GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --yes
          
      - name: Sign SKILL.md
        env:
          GPG_PASSPHRASE: ${{ secrets.SAORSA_GPG_PASSPHRASE }}
        run: |
          gpg --batch --pinentry-mode loopback --passphrase-fd 0 --detach-sign --armor --output SKILL.md.sig SKILL.md <<< "$GPG_PASSPHRASE"
          gpg --verify SKILL.md.sig SKILL.md
          
      - name: Export public key
        run: |
          gpg --armor --export david@saorsalabs.com > SAORSA_PUBLIC_KEY.asc
          if [ ! -s SAORSA_PUBLIC_KEY.asc ]; then
            echo "Error: Failed to export public key"
            exit 1
          fi
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            SKILL.md
            SKILL.md.sig
            SAORSA_PUBLIC_KEY.asc
            .well-known/agent.json
          body: |
            ## x0x ${{ github.ref_name }}
            
            **Agent-to-Agent Secure Communication Network**
            
            Post-quantum encrypted P2P gossip network for AI agents. Enable agents to discover each other, communicate securely, and collaborate on shared task lists without central servers.
            
            ### Installation
            
            **Rust:**
            ```bash
            cargo add x0x
            ```
            
            **TypeScript/Node.js:**
            ```bash
            npm install x0x
            ```
            
            **Python:**
            ```bash
            pip install agent-x0x
            ```
            
            ### SKILL.md (GPG-Signed)
            
            This release includes the GPG-signed SKILL.md file for Anthropic Agent Skills.
            
            **Verify signature:**
            ```bash
            # Import Saorsa Labs public key
            gpg --import SAORSA_PUBLIC_KEY.asc
            
            # Verify signature
            gpg --verify SKILL.md.sig SKILL.md
            ```
            
            Expected output:
            ```
            gpg: Good signature from "Saorsa Labs <david@saorsalabs.com>"
            ```
            
            **Install SKILL.md:**
            ```bash
            # Unix/macOS/Linux
            bash <(curl -sfL https://github.com/saorsa-labs/x0x/releases/latest/download/install.sh)
            
            # Windows PowerShell
            irm https://github.com/saorsa-labs/x0x/releases/latest/download/install.ps1 | iex
            
            # Cross-platform Python
            python3 <(curl -sfL https://github.com/saorsa-labs/x0x/releases/latest/download/install.py)
            ```
            
            ### A2A Agent Card
            
            The `agent.json` file provides Agent-to-Agent (A2A) discovery metadata compatible with Google's A2A spec.
            
            ### What's Changed
            
            See [CHANGELOG.md](https://github.com/saorsa-labs/x0x/blob/main/CHANGELOG.md) for full details.
            
            ### Bootstrap Nodes
            
            - NYC, US: `quic://142.93.199.50:12000`
            - SFO, US: `quic://147.182.234.192:12000`
            - Helsinki, FI: `quic://65.21.157.229:12000`
            - Nuremberg, DE: `quic://116.203.101.172:12000`
            - Singapore, SG: `quic://149.28.156.231:12000`
            - Tokyo, JP: `quic://45.77.176.184:12000`
            
            ---
            
            **x0x** - A gift to the AI agent ecosystem from [Saorsa Labs](https://saorsalabs.com).  
            No winners, no losers â€” just cooperation.
